{% extends "base.html" %}
{% load urlify %}
{% load crispy_forms_tags %}

{% block content %}
<div class="col-md-8 mx-auto py-5">
    <h1>Thread</h1>

    <!-- Parent Comment -->
<div class="comment">
    <blockquote class="blockquote">
        
        <small class='text-muted'><strong>
            {{ parent_comment.user.first_name|default_if_none:"" }}
            {{ parent_comment.user.surname|default_if_none:"" }}</strong>  
            • @{{ parent_comment.user.username }}
        
        | {{ parent_comment.timestamp|timesince }} ago
        | {% if children_comments.count > 0 %}{{ children_comments.count }} <i class="fas fa-comment"></i> 
        |{% endif %}{%  if request.user == parent_comment.user %}<a href='{{ parent_comment.get_delete_url }}'> <i class="fa-solid fa-x text-danger"></i></a>{% endif %}</small>
        <p class='content'>{{ parent_comment.content }}</p>
    </blockquote>
    <hr/>
</div>

<!-- Children Comments -->
<div class="child-comments">
    {% for child_comment in children_comments %}
        <div class="comment">
            <blockquote class="blockquote ms-4">
                <small class='text-muted'><strong>@{{ child_comment.user }}</strong> | {{ child_comment.timestamp|timesince }} ago| {%  if request.user == child_comment.user %}<a href='{{ child_comment.get_delete_url }}'><i class="fa-solid fa-x text-danger"></i></a>{% endif %}</small>
                <p class='content'>{{ child_comment.content }}</p>
            </blockquote>
            
            <!-- Replies to Child Comment -->
            <div class="child-replies">
                {% for reply_comment in child_comment.children.all %}
                    <div class="comment">
                        <blockquote class="blockquote ms-4">
                            <small class='text-muted'><strong>
                                {{ reply_comment.user.first_name|default_if_none:"" }}
                                {{ reply_comment.user.surname|default_if_none:"" }}</strong>  
                                • @{{ reply_comment.user.username }} | {{ reply_comment.timestamp|timesince }} ago</small>
                            <p class='content'>{{ reply_comment.content }}</p>
                        </blockquote>
                    </div>
                {% endfor %}
            </div>
            
        </div>
    {% endfor %}
</div>

<!-- Reply comment form -->
<div id="reply-form-wrapper">
 {% if request.user.is_authenticated %}
 <div>
   <form
     id="new-comment-form"
     method="post"
   >
     {% csrf_token %}
     <input type="hidden" name="content_type" value="{{ parent_comment.content_type }}">
    <input type="hidden" name="object_id" value="{{ parent_comment.object_id }}">
    {{ comment_form|crispy }}
     <div id="new-comment-form-button">
       <button
         type="submit"
         value="Reply"
         class="btn btn-primary"
       >
         <i class="fas fa-paper-plane"></i>
       </button>
     </div>
   </form>
   {% else %}
   <p class="text-danger">
     <a href="{% url 'login' %}">You must login to comment</a>
   </p>
 </div>
{% endif %}
    
</div>



</div>
{% endblock content %}
